version: v1.0
name: Standard Java build, test, deploy pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
    
blocks:
  - name: Build-Test-Deploy using Maven
    task:
      env_vars:
        - name: DATABASE_USERNAME
          value: "root"
        - name: DATABASE_PASSWORD
          value: ""
        - name: DATABASE_DIALECT
          value: "org.hibernate.dialect.MySQL8Dialect"
        - name: DATABASE_DRIVER
          value: "com.mysql.cj.jdbc.Driver"
      jobs:
        - name: Running test using Junit, Deploy AWS Lambda Function
          commands:
            - cache restore maven-$SEMAPHORE_GIT_BRANCH-$(checksum pom.xml)
            - sem-service start mysql 8
            - sudo apt-get install -y -qq mysql-client
            - sem-service status mysql
            - checkout

 # first run test using JUnit
            - mvn dependency:go-offline test -f pom-restful-api.xml

 # using maven to first package then to deploy the generated Lambda functions.  
 # Make sure the key vars (USER_AWS_ACCESSKEY and USER_AWS_SECRETKEY) are read in as env vars for the current project.
 # Either enter them in the UI console under 'Configuration-->Secrets' or following instructions at https://docs.semaphoreci.com/article/66-environment-variables-and-secrets
            - mvn package lambda:delete-lambda lambda:deploy-lambda -f pom-aws-lambda.xml  -DAWS_ACCESSKEY=$USER_AWS_ACCESSKEY -DAWS_SECRETKEY=$USER_AWS_SECRETKEY # deploy the lambda functions 
            - cache store maven-$SEMAPHORE_GIT_BRANCH-$(checksum pom.xml)-$(checksum pom.xml) ~/.m2
            