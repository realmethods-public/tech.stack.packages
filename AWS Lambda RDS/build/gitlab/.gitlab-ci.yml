image: java:8
image: maven:3.3.9 

services:
- mysql:8.0

cache:
  paths:
    - .m2/repository/
    - target/
    
variables:
  DATABASE_USERNAME: "root"
  DATABASE_PASSWORD: ""
  DATABASE_DIALECT: "org.hibernate.dialect.MySQL8Dialect"
  DATABASE_DRIVER: "com.mysql.cj.jdbc.Driver"
  DATABASE_URL: "jdbc:mysql://mysql:3306/gitlabtest?createDatabaseIfNotExist=true"
  DATABASE_NAME: "gitlabtest"
  MYSQL_ROOT_PASSWORD: ""
  MYSQL_ALLOW_EMPTY_PASSWORD: "true"
  
cache:
  paths:
    - .m2/repository/
    - target/

stages:
  - build

build:
  stage: build
  script: 
    - mvn test -f pom-restful-api.xml 
  # using maven to first package then to deploy the generated Lambda functions.  
  # You must assign the key vars (USER_AWS_ACCESSKEY and USER_AWS_SECRETKEY) as env vars for the current project.
    - mvn package lambda:delete-lambda lambda:deploy-lambda -f pom-aws-lambda.xml -DAWS_ACCESSKEY=$USER_AWS_ACCESSKEY -DAWS_SECRETKEY=$USER_AWS_SECRETKEY    
  artifacts:
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
        - target/failsafe-reports/TEST-*.xml    
      